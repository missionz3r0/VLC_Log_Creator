<!DOCTYPE html>

<html>

  <head>
    <style>
      .card-title{
        color: black;
      }
    </style>
    <meta charset="UTF-8">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  </head>
  <body>
    <!--<button type="button" onClick="generateERLogs();">Create Logs</button>-->
    <button type="button" onClick="input2JSON();">Export</button>
    <input type="file" id="fileImport">
    <p style="text-align: center;">
      Current Level: <span id="currentLevel">0</span>
    </p>
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="logs-tab" data-toggle="tab" href="#logs" role="tab" aria-controls="logs" aria-selected="true">Logs</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="encounterReports-tab" data-toggle="tab" href="#encounterReports" role="tab" aria-controls="encounterReports" aria-selected="false">Encounter Reports</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="transactions-tab" data-toggle="tab" href="#transactions" role="tab" aria-controls="transactions" aria-selected="false">Transactions</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="gear-tab" data-toggle="tab" href="#gear" role="tab" aria-controls="gear" aria-selected="false">Gear</a>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="logs" role="tabpanel" aria-labelledby="logs-tab">
        <div class="card">
          <div class="card-body">
            <a data-toggle="collapse" area-expanded="false" aria-controls="expLog_container" href="#expLog_container">
              <h5 class="card-title">Experience Log</h5>
            </a>
            <div class="collapse" id="expLog_container">
              <h6 id="expLogSub" class="card-subtitle mb-2 text-muted"></h6>
              <p id="expLog" class="card-text"></p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <a data-toggle="collapse" area-expanded="false" aria-controls="lootLog_container" href="#lootLog_container">
              <h5 class="card-title">Loot Log</h5>
            </a>
            <div class="collapse" id="lootLog_container">
              <h6 id="lootLogSub" class="card-subtitle mb-2 text-muted"></h6>
              <p id="lootLog" class="card-text"></p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <a data-toggle="collapse" area-expanded="false" aria-controls="downtimeLog_container" href="#downtimeLog_container">
              <h5 class="card-title">Downtime Log</h5>
            </a>
            <div class="collapse" id="downtimeLog_container">
              <h6 id="downtimeLogSub" class="card-subtitle mb-2 text-muted"></h6>
              <p id="downtimeLog" class="card-text"></p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <a data-toggle="collapse" area-expanded="false" aria-controls="retrainingLog_container" href="#retrainingLog_container">
              <h5 class="card-title">(Re)Training Log</h5>
            </a>
            <div class="collapse" id="retrainingLog_container">
              <h6 id="retrainingLogSub" class="card-subtitle mb-2 text-muted"></h6>
              <p id="retrainingLog" class="card-text"></p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <a data-toggle="collapse" area-expanded="false" aria-controls="itemLog_container" href="#itemLog_container">
              <h5 class="card-title">Item Access Log</h5>
            </a>
            <div class="collapse" id="itemLog_container">
              <h6 id="itemAccessLogSub" class="card-subtitle mb-2 text-muted"></h6>
              <p id="itemAccessLog" class="card-text"></p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <a data-toggle="collapse" area-expanded="false" aria-controls="transactionLog_container" href="#transactionLog_container">
              <h5 class="card-title">Transaction Log</h5>
            </a>
            <div class="collapse" id="transactionLog_container">
              <h6 id="transactionLogSub" class="card-subtitle mb-2 text-muted"></h6>
              <p id="transactionLog" class="card-text"></p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <a data-toggle="collapse" area-expanded="false" aria-controls="gearLog_container" href="#gearLog_container">
              <h5 class="card-title">Gear Log</h5>
            </a>
            <div class="collapse" id="gearLog_container">
              <h6 id="gearLogSub" class="card-subtitle mb-2 text-muted"></h6>
              <p id="gearLog" class="card-text"></p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <a data-toggle="collapse" area-expanded="false" aria-controls="bankingLog_container" href="#bankingLog_container">
              <h5 class="card-title">Banking Log</h5>
            </a>
            <div class="collapse" id="bankingLog_container">
              <h6 id="bankingLogSub" class="card-subtitle mb-2 text-muted"></h6>
              <p id="bankingLog" class="card-text"></p>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="encounterReports" role="tabpanel" aria-labelledby="encounterReports-tab">
        <table class="table">
          <thead class="thead-dark">
            <tr>
              <th></th>
              <th>ER Code</th>
              <th>ER Point Value</th>
              <th>Bonus Points</th>
              <th>Item Access</th>
              <th>Banked?</th>
              <!--<th>Apply After</th>-->
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="ER_Input">
          </tbody>
        </table>
        <button type="button" onClick="addERInput();">Add Encounter Report</button>
      </div>
      <div class="tab-pane fade" id="transactions" role="tabpanel" aria-labelledby="transactions-tab">
        <table class="table">
          <thead class="thead-dark">
            <tr>
              <th></th>
              <th>Name</th>
              <th>Date Purchased</th>
              <th>Cost Per</th>
              <th>Number Purchased</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="Transaction_Input">
          </tbody>
        </table>
        <button type="button" onClick="addTransactionInput();">Add Transaction</button>
      </div>
      <div class="tab-pane fade" id="gear" role="tabpanel" aria-labelledby="gear-tab">
        <table class="table">
          <thead class="thead-dark">
            <tr>
              <th></th>
              <th>Name</th>
              <th>Container</th>
              <th>Weight Per</th>
              <th>Number Remaining</th>
              <th>Is this a Container?</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="Gear_Input">
          </tbody>
        </table>
        <button type="button" onClick="addGearInput();">Add Gear</button>
      </div>
    </div>

  </body>
</html>
<script
			  src="https://code.jquery.com/jquery-3.3.1.min.js"
			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			  crossorigin="anonymous">
</script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
<script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous">
</script>
<script>
$('#ER_Input').sortable({
  update: function(event, ui){
    generateERLogs();
  }
});

$('#Transaction_Input').sortable();
$('#Gear_Input').sortable();

const erInput = document.getElementById('ER_Input');
const transactionInput = document.getElementById('Transaction_Input');
const gearInput = document.getElementById('Gear_Input');
const lvl2loot = {
  1:  286,
  2:  321,
  3:  378,
  4:  459,
  5:  562,
  6:  689,
  7:  838,
  8: 1011,
  9: 1206,
  10:1425,
  11:1666,
  12:1931,
  13:2218,
  14:2529,
  15:2862,
  16:3219,
  17:3598,
  18:4001,
  19:4426,
  20:4875,
  21:4875
};

const expObjects = {
  1: {min: 0, max: 3},
  2: {min: 4, max: 9},
  3: {min: 10, max: 17},
  4: {min: 18, max: 27},
  5: {min: 28, max: 39},
  6: {min: 40, max: 53},
  7: {min: 54, max: 69},
  8: {min: 70, max: 87},
  9: {min: 88, max: 107},
  10: {min: 108, max: 129},
  11: {min: 130, max: 153},
  12: {min: 154, max: 179},
  13: {min: 180, max: 207},
  14: {min: 208, max: 237},
  15: {min: 238, max: 269},
  16: {min: 270, max: 303},
  17: {min: 304, max: 339},
  18: {min: 340, max: 377},
  19: {min: 378, max: 417},
  20: {min: 418, max: 1000000},
  21: {min: 1000001, max: 99900000}
}

const lvl2downtime = {
  1: 3,
  2: 3,
  3: 3,
  4: 3,
  5: 3,
  6: 3,
  7: 2,
  8: 2,
  9: 2,
  10: 2,
  11: 2,
  12: 1,
  13: 1,
  14: 1,
  15: 1,
  16: 1,
  17: 1,
  18: 1,
  19: 1,
  20: 1,
  21: 0
}

function exp2lvl(experience){
  for (key in expObjects){
    if((experience >= expObjects[key]['min']) && (experience <= expObjects[key]['max']))
      return key;
  }
}

function addERInput(){
  let newElement = document.createElement("tr");
  newElement.innerHTML = `
      <td><span style="cursor: pointer;">&#9776;</span></td>
      <td><input type="text" class="erCode"></td>
      <td><input type="number" class="points"></td>
      <td><input type="number" class="bonusPoints"></td>
      <td><input type="text" class="itemAccess"></td>
      <td><input type="checkbox" class="isBanked"></td>
      <td><span class="deleteER" style="cursor: pointer; color: red;">&#10008;</span></td>
  `;

  //<td><select class="applyAfter" disabled></select></td>

  erInput.appendChild(newElement);
  return newElement;
}

function addTransactionInput(){
  let newElement = document.createElement("tr");
  newElement.innerHTML = `
      <td><span style="cursor: pointer;">&#9776;</span></td>
      <td><input type="text" class="transactionName"></td>
      <td><input type="date" class="transactionDate" value="`+(new Date().toJSON().slice(0, 10))+`"></td>
      <td><input type="number" class="transactionCost"></td>
      <td><input type="number" class="transactionNumberPurchased" value="1"></td>
      <td><span class="transactionDelete" style="cursor: pointer; color: red;">&#10008;</span></td>
  `;

  transactionInput.appendChild(newElement);
  return newElement;
}

function addGearInput(){
  let newElement = document.createElement("tr");
  newElement.innerHTML = `
      <td><span style="cursor: pointer;">&#9776;</span></td>
      <td><input type="text" class="gearName"></td>
      <td>
        <select class="gearContainer">
          <optgroup>
            <option value="Carried">Carried</option>
            <option value="Not Carried">Not Carried</option>
          </optgroup>
          <optgroup class="gearAvailableContainers" label="Containers">
          </optgroup>
        </select>
      </td>
      <td><input type="number" class="gearWeight"></td>
      <td><input type="number" class="gearNumberRemaining" value="1"></td>
      <td><input type="checkbox" class="gearIsContainer"></td>
      <td><span class="gearDelete" style="cursor: pointer; color: red;">&#10008;</span></td>
  `;

  gearInput.appendChild(newElement);
  return newElement;
}

function addBankedReportsToReportOrder(reportOrder, bankedReportsNeedingApplied, reports){
  if(bankedReportsNeedingApplied.length > 0){
    for(let i = bankedReportsNeedingApplied.length-1;i >= 0;i--){
      let applyAfter = reports[bankedReportsNeedingApplied[i]]['applyAfter'];
      let indexToInsert = reportOrder.indexOf(applyAfter)+1;
      if(indexToInsert > 0){
        reportOrder.splice(indexToInsert, 0, bankedReportsNeedingApplied[i]);
        bankedReportsNeedingApplied.splice(i, 1);
      }
      else{
        if(bankedReportsNeedingApplied.indexOf(applyAfter) == -1)
          bankedReportsNeedingApplied.splice(i, 1);
      }
    }

    return addBankedReportsToReportOrder(reportOrder, bankedReportsNeedingApplied, reports);
  }
  else{
    return reportOrder;
  }

}

var totalExp = 0;
var totalLoot = 200;
var totalLootPoints = 0;
var totalBonusPoints = 0;
var currentBonusPoints = 0;
var totalDowntime = 3
var totalSpent = 0;
var totalSold = 0;

function generateERLogs(){
  totalExp = 0;
  let expLog = '';

  totalLoot = 200;
  totalLootPoints = 0;
  let lootLog = '200 - Starting Gold<br>';

  totalBonusPoints = 0;
  currentBonusPoints = 0;

  totalDowntime = 3
  let downtimeLog = '3 DP - Level 1<br>';

  let accessLog = '';

  let reportOrder = [];
  let bankedReportsNeedingApplied = [];
  let reports = {};

  let bankedLogs = '';

  $('#ER_Input tr').each(function(){
    let erCode = $(this).find('.erCode').val();
    let expPoints = parseInt($(this).find('.points').val()) || 0;
    let bonusPoints = parseInt($(this).find('.bonusPoints').val()) || 0;
    let itemAccess = $(this).find('.itemAccess').val();
    let isBanked = $(this).find('.isBanked').is(':checked');
    let applyAfter = $(this).find('.applyAfter').val() || '';

    reports[erCode] = {
      points: parseInt($(this).find('.points').val()) || 0,
      bonusPoints: parseInt($(this).find('.bonusPoints').val()) || 0,
      itemAccess: $(this).find('.itemAccess').val(),
      applyAfter: applyAfter
    }

    if(!isBanked){
      reportOrder.push(erCode);
    }
    else if(applyAfter.length > 0){
      bankedReportsNeedingApplied.push(erCode);
      bankedLogs += erCode +'- applied after '+applyAfter+'<br>';
    }
    else{
      bankedLogs += erCode+'<br>';
    }
  })

  reportOrder = addBankedReportsToReportOrder(reportOrder, bankedReportsNeedingApplied, reports);

  for(report of reportOrder){
    let erCode = report;
    let expPoints = reports[report]['points'];
    let downtimePoints = expPoints;
    let lootPoints = expPoints;
    let bonusPoints = reports[report]['bonusPoints'];
    let itemAccess = reports[report]['itemAccess'];

    downtimeLog += downtimePoints+' DP - '+erCode+'<br>';
    totalDowntime += downtimePoints;

    let currentLvl = parseInt(exp2lvl(totalExp));

    if(expPoints > 0){
      let lootPointsApplied = 0;
      let loot = 0;
      let lootPointsString = '';
      let lootGoldString = '';
      for(let i=currentLvl;i<=parseInt(exp2lvl(totalExp+expPoints));i++){
        let lootPointsToApply = 0;
        if((totalLootPoints+lootPoints-lootPointsApplied)>(expObjects[i]['max']+1))
          lootPointsToApply = expObjects[i]['max']+1-totalLootPoints;
        else
          lootPointsToApply = lootPoints-lootPointsApplied;

        if(lootPointsToApply != 0){
          lootPointsString += lootPointsToApply+' LP (Level '+i+'), ';
          lootGoldString += lootPointsToApply+'*'+lvl2loot[i]+'+'
          loot += lootPointsToApply*lvl2loot[i];
          totalLootPoints += lootPointsToApply;
          lootPointsApplied += lootPointsToApply;
        }

        if(i != currentLvl){
          downtimeLog += lvl2downtime[i]+' DP - Level '+i+'<br>';
          totalDowntime += lvl2downtime[i];
        }
      }
      lootLog+=lootPointsString.slice(0,-2) +' and '+bonusPoints+' BP - '+erCode+' ('+lootGoldString.slice(0,-1)+'='+loot+')<br>';
      totalLoot+=loot;

      totalBonusPoints += bonusPoints;
      currentBonusPoints += bonusPoints;
      if(currentBonusPoints >= 5){
        let numConvertedLootPoints = (currentBonusPoints-(currentBonusPoints%5))/5;
        currentBonusPoints -= numConvertedLootPoints*5;
        lootLog += 'Converting ' + (numConvertedLootPoints*5) + ' BP into '+numConvertedLootPoints+' LP (Level '+currentLvl+') = ' + (numConvertedLootPoints*lvl2loot[currentLvl])+'<br>';
        totalLoot += numConvertedLootPoints*lvl2loot[currentLvl];
      }

      totalExp += expPoints;

      expLog += expPoints+' XP - '+erCode+'<br>';
    }

    accessLog += erCode+' - '+itemAccess+'<br>';
  }

  $('#expLog').html(expLog);
  $('#expLogSub').html('EXP: '+totalExp);
  $('#currentLevel').html(exp2lvl(totalExp));
  $('#lootLog').html(lootLog);
  $('#lootLogSub').html('Total: '+(totalLoot-(totalSpent-totalSold))+'g BP: '+currentBonusPoints+' (Total '+totalBonusPoints+')');
  $('#downtimeLog').html(downtimeLog);
  $('#downtimeLogSub').html('C:'+(totalDowntime%3)+'/3 Total: '+totalDowntime+' Days Earned: '+(((totalDowntime-(totalDowntime%3))/3)*7));
  $('#itemAccessLog').html(accessLog);
  $('#bankingLog').html(bankedLogs);

  generateTransactionLogs();
}

function generateTransactionLogs(){
  totalSpent = 0;
  totalSold = 0;

  let transactionLog = '';

  let transactions = {};

  $('#Transaction_Input tr').each(function(){
    let name = $(this).find('.transactionName').val();
    let date = $(this).find('.transactionDate').val();
    date.setTime( date.getTime() + date.getTimezoneOffset()*60*1000 );
    let cost = parseFloat($(this).find('.transactionCost').val()) || 0;
    let numberPurchased = parseInt($(this).find('.transactionNumberPurchased').val()) || 0

    if(!(date in transactions)){
      transactions[date] = [];
    }

    transactions[date].push({
      "name": name,
      "cost": cost,
      "numberPurchased": numberPurchased
    });

  });

  for (dateString in transactions){
    let transactionDate = new Date(dateString);
    transactionLog += (transactionDate.getMonth()+1)+'/'+(transactionDate.getDate())+'/'+transactionDate.getFullYear()+' - <ul style="list-style-type:none;">';

    let boughtItems = [];
    let soldItems = [];

    for (transaction of transactions[dateString]){
      let text = ''
      if (transaction.numberPurchased > 1)
        text += transaction.name+'['+transaction.numberPurchased+'] ('+transaction.cost * transaction.numberPurchased+')';
      else
        text += transaction.name+' ('+transaction.cost * transaction.numberPurchased+')';
      if(transaction.cost >= 0){
        totalSpent += transaction.cost * transaction.numberPurchased;
        boughtItems.push(text);
      }
      else{
        totalSold -= transaction.cost *transaction.numberPurchased;
        soldItems.push(text);
      }
    }

    if(boughtItems.length > 0)
      transactionLog += '<li>Bought: ' + boughtItems.join(', ')+'</li>';

    if(soldItems.length > 0)
      transactionLog += '<li>Sold: ' + soldItems.join(', ')+'</li>';

    transactionLog += '</ul><br>'
  }


  $('#lootLogSub').html('Current: '+(totalLoot-(totalSpent-totalSold))+'gp, Total: '+totalLoot+', BP: '+currentBonusPoints+' (Total '+totalBonusPoints+')');

  $('#transactionLogSub').html('Spent: '+totalSpent+'g, Sold: '+totalSold+'g, Net Loss: '+(totalSpent-totalSold))+'g';
  $('#transactionLog').html(transactionLog);
}

function generateGearLogs(){
  let gearLog = '';
  let totalWeight = 0;
  let containers = ['Carried', 'Not Carried'];
  let gear = {};

  $('#Gear_Input tr').each(function(){
    $this = $(this);
    let name = $this.find('.gearName').val();
    let container = $this.find('.gearContainer').val() || 'Carried';
    let weight = parseFloat($this.find('.gearWeight').val()) || 0;
    let numberRemaining = parseInt($this.find('.gearNumberRemaining').val()) || 0
    let isContainer = $this.find('.gearIsContainer').is(':checked');

    if(isContainer){
      containers.push(name);
    }

    if(!(container in gear)){
      gear[container] = [];
    }

    gear[container].push({
      "name": name,
      "weight": weight,
      "numberRemaining": numberRemaining
    });

  });

  for (container of containers){
    if(container in gear){
      let containerHTML = container+':<br><ul style="list-style-type:none;">';

      for(item of gear[container]){
        containerHTML += '<li>'
        if (item.numberRemaining == 1)
          containerHTML += item.name +' ('+item.weight+')';
        else
          containerHTML += item.name +'['+item.numberRemaining+'] ('+item.weight+')';
        containerHTML += '</li>';
        totalWeight += item.weight * item.numberRemaining;
      }

      gearLog += containerHTML + '</ul><br><br>';
    }
  }

  $('#gearLogSub').html('Weight: '+totalWeight);
  $('#gearLog').html(gearLog);

}

function input2JSON(){
  let jsonFile = {errts: [], transactions: [], gear: []};
  $('#ER_Input tr').each(function(){
    $this = $(this);
    jsonFile['errts'].push({
      ERCode: $this.find('.erCode').val(),
      ERPoints: parseInt($this.find('.points').val()),
      BonusPoints: parseInt($this.find('.bonusPoints').val()),
      ItemAccess: $this.find('.itemAccess').val(),
      IsBanked: $this.find('.isBanked').is(':checked')
    });
  });

  $('#Transaction_Input tr').each(function(){
    $this = $(this);
    jsonFile['transactions'].push({
      Name: $this.find('.transactionName').val(),
      'Date': $this.find('.transactionDate').val(),
      Cost: parseFloat($this.find('.transactionCost').val()),
      NumberPurchased: parseInt($this.find('.transactionNumberPurchased').val())
    });
  });

  $('#Gear_Input tr').each(function(){
    $this = $(this);
    jsonFile['gear'].push({
      Name: $this.find('.gearName').val(),
      Container: $this.find('.gearContainer').val(),
      Weight: parseFloat($this.find('.gearWeight').val()),
      NumberRemaining: parseInt($this.find('.gearNumberRemaining').val()),
      IsContainer: $this.find('.gearIsContainer').is(':checked')
    });
  });

  let file = new Blob([JSON.stringify(jsonFile)], {type: "application/json"});
  let filename  = prompt("File Name:")+'.json';
  if (window.navigator.msSaveOrOpenBlob) // IE10+
      window.navigator.msSaveOrOpenBlob(file, filename);
  else { // Others
      var a = document.createElement("a"),
              url = URL.createObjectURL(file);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function() {
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
      }, 0);
  }
}

function JSON2Input(evt){
  erInput.innerHTML = '';
  let file = evt.target.files[0];
  let reader = new FileReader();

  reader.onload = function(progressEvent){
    let jsonFile = JSON.parse(this.result);

    $('#ER_Input').html('');
    $('#Transaction_Input').html('');
    $('#Gear_Input').html('');

    if('errts' in jsonFile){
      for(errt of jsonFile['errts']){
        let $element = $(addERInput());

        $element.find('.erCode').val(errt['ERCode']);
        $element.find('.points').val(errt['ERPoints']);
        $element.find('.bonusPoints').val(errt['BonusPoints']);
        $element.find('.itemAccess').val(errt['ItemAccess']);
        $element.find('.isBanked').val(errt['IsBanked']);
      }
    }

    if('transactions' in jsonFile){
      for(transaction of jsonFile['transactions']){
        let $element = $(addTransactionInput());

        $element.find('.transactionName').val(transaction['Name']);
        $element.find('.transactionDate').val(transaction['Date']);
        $element.find('.transactionCost').val(transaction['Cost']);
        $element.find('.transactionNumberPurchased').val(transaction['NumberPurchased']);
      }
    }

    if('gear' in jsonFile){
      let delayedContainers = [];

      for(gear of jsonFile['gear']){
        let $element = $(addGearInput());

        $element.find('.gearName').val(gear['Name']);
        if($element.find("option[value='"+gear['Container']+"']").length > 0){
          $element.find('.gearContainer').val(gear['Container']);
        }
        else{
          delayedContainers.push({containerSelect: $element.find('.gearContainer'), container:gear['Container']});
        }
        $element.find('.gearWeight').val(gear['Weight']);
        $element.find('.gearNumberRemaining').val(gear['NumberRemaining']);
        $element.find('.gearIsContainer').prop('checked', gear['IsContainer']);
      }

      for (delayedContainer of delayedContainers){
        fillGearSelect(delayedContainer.containerSelect);
        delayedContainer.containerSelect.val(delayedContainer['container']);
      }
    }

     generateERLogs();
     generateTransactionLogs();
     generateGearLogs();
  }

  reader.readAsText(file);
}

$('#fileImport').change(JSON2Input);

addERInput();
addTransactionInput();
addGearInput();

$('#ER_Input').on('blur', 'input', generateERLogs);
$('#ER_Input').on('focus', '.applyAfter', function(){
  let html = '<option value="None">None</option>';
  let $applyAfter = $(this);
  let originalValue = $applyAfter.parent().parent().find('.erCode').val()

  $applyAfter.html('');
  $('.erCode').each(function(){
    let val = $(this).val();

    if(val != originalValue)
      html+= '<option value="'+val+'">'+val+'</option>';
  });

  $applyAfter.html(html);

});
$('#ER_Input').on('change', '.isBanked', function(){
  let $parent = $(this).parent().parent();
  if($(this).is(':checked')){
    $parent.find('.applyAfter').prop('disabled', false);
  }
  else{
    $parent.find('.applyAfter').prop('disabled', true);
    $parent.find('.applyAfter').val('');
  }
  generateERLogs();
});
$('#ER_Input').on('keypress', 'input', function(event){
  let keycode = (event.keyCode ? event.keyCode : event.which);
  if(keycode == '13'){
    $(addERInput()).find('.erCode').focus();
  }
})

$('#ER_Input').on('change', '.applyAfter', generateERLogs);

$('#ER_Input').on('click', '.deleteER', function(){
  if(confirm('Delete ER Log named: '+ $(this).closest('tr').find('.erCode').val()+'?')){
    $(this).closest('tr').remove();
    generateERLogs();
  }
});

$('#Transaction_Input').on('blur', 'input', generateTransactionLogs);

$('#Transaction_Input').on('keypress', 'input', function(event){
  let keycode = (event.keyCode ? event.keyCode : event.which);
  if(keycode == '13'){
    $(addTransactionInput()).find('.transactionName').focus();
  }
})

$('#Transaction_Input').on('click', '.transactionDelete', function(){
  if(confirm('Delete Transaction Log named: '+ $(this).closest('tr').find('.transactionName').val()+'?')){
    $(this).closest('tr').remove();
    generateTransactionLogs();
  }
});

$('#Gear_Input').on('blur', 'input,select', generateGearLogs);

$('#Gear_Input').on('keypress', 'input', function(event){
  let keycode = (event.keyCode ? event.keyCode : event.which);
  if(keycode == '13'){
    $(addGearInput()).find('.gearName').focus();
  }
})

$('#Gear_Input').on('click', '.gearDelete', function(){
  if(confirm('Delete Gear Log named: '+ $(this).closest('tr').find('.gearName').val()+'?')){
    $(this).closest('tr').remove();
    generateGearLogs();
  }
});

function fillGearSelect($element){
  let html = '';

  let originName = $element.closest('tr').find('.gearName').val();

  let $containers = $element.find('.gearAvailableContainers')

  $containers.html('');
  $(gearInput).find('tr').each(function(){
    let $this = $(this);
    let name = $this.find('.gearName').val();

    if($this.find('.gearIsContainer').is(':checked') && name != originName){
      html+= '<option value="'+name+'">'+name+'</option>';
    }
  });

  $containers.html(html);

}

$('#Gear_Input').on('focus', '.gearContainer', function(){
  let html = '';

  let originName = $(this).closest('tr').find('.gearName').val();

  let $containers = $(this).find('.gearAvailableContainers')

  $containers.html('');
  $(gearInput).find('tr').each(function(){
    let $this = $(this);
    let name = $this.find('.gearName').val();

    if($this.find('.gearIsContainer').is(':checked') && name != originName){
      html+= '<option value="'+name+'">'+name+'</option>';
    }
  });

  $containers.html(html);

});
</script>
